<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ema genie clusters with custom properties</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src='https://npmcdn.com/csv2geojson@latest/csv2geojson.js'></script>
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
<style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    /* Popup styling */

    .mapboxgl-popup {
      padding-bottom: 5px;
    }

    .mapboxgl-popup-close-button {
      display: none;
    }

    .mapboxgl-popup-content {
      font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      padding: 0;
      width: 250px;
    }

    .mapboxgl-popup-content-wrapper {
      padding: 1%;
    }

    .mapboxgl-popup-content h3 {
      background: rgb(61, 59, 59);
      text-align: center;
      color: #fff;
      margin: 0;
      display: block;
      padding: 15px;
      font-weight: 700;
      margin-top: -5px;
    }

    .mapboxgl-popup-content h4 {
      margin: 0;
      display: block;
      padding: 10px 3px 10px 10px;
      font-weight: 400;
    }

    .mapboxgl-container {
      cursor: pointer;
    }

    .mapboxgl-popup-anchor-top>.mapboxgl-popup-content {
      margin-top: 3px;
    }

    .mapboxgl-popup-anchor-top>.mapboxgl-popup-tip {
      border-bottom-color: rgb(61, 59, 59);
    }
    .filter-ctrl {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
    }
        
    .filter-ctrl input[type='text'] {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        width: 100%;
        border: 0;
        background-color: #fff;
        margin: 0;
        color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        width: 180px;
    }
    /**
    * Set rules for how the map overlays
    * (information box and legend) will be displayed
    * on the page. */
    .map-overlay {
        position: absolute;
        bottom: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.8);
        margin-right: 10px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        overflow: auto;
        border-radius: 3px;
    }

    #legend {
        padding: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 18px;
        height: auto;
        margin-bottom: 40px;
        width: auto;
    }

    .legend-key {
        display: inline-block;
        border-radius: 20%;
        width: 10px;
        height: 10px;
        margin-right: 5px;
    }
    #menu {
        background: #fff;
        position: absolute;
        z-index: 1;
        top: 55px;
        left: 10px;
        border-radius: 3px;
        width: 120px;
        border: 1px solid rgba(0, 0, 0, 0.4);
        font-family: 'Open Sans', sans-serif;
    }
    
    #menu a {
        font-size: 13px;
        color: #404040;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        text-decoration: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
        text-align: center;
    }
    
    #menu a:last-child {
        border: none;
    }
    
    #menu a:hover {
        background-color: #f8f8f8;
        color: #404040;
    }
    
    #menu a.active {
        background-color: #3887be;
        color: #ffffff;
    }
    
    #menu a.active:hover {
        background: #3074a4;
    }
</style>
</head>
<body>
<nav id="menu"></nav>
<div id="map"></div>
<div class="filter-ctrl" style="display: none;">
    <input id="filter-input" type="text" name="filter" placeholder="Filter by text"/>
</div>
<div class='map-overlay' id='legend'></div>
<script>
    var filterInput = document.getElementById('filter-input');
	mapboxgl.accessToken = 'pk.eyJ1IjoiZ2VvbXVuZHVzIiwiYSI6ImNqM3BoMDVlYjAwam8zMnBmNm1ndWs3bnYifQ.McVUJig2reapiExh7EPOpw';
    var map = new mapboxgl.Map({
        container: 'map',
        zoom: 1,
        center: [0, 20],
        //style: 'mapbox://styles/mapbox/light-v10'
        style: 'mapbox://styles/geomundus/ckic4cpgt1cn919pmztwnpgum'
    });

    map.addControl(new mapboxgl.NavigationControl());

    // filters for classifying ema_genie into five categories
    const occupations = ['I recently graduated and I am looking for a job','I work in a private company','I am a 1st year Master student','I work for the government','I am a researcher/doing my PhD','I work at a university or public institute','Other'];
    const fieldOfStudies = ['Natural Sciences (Astronomy, Biology, Chemistry, Earth Science, Environment and Physics)','Engineering and Technology','Social Sciences and Humanities','Geography','Economic Science','Cultural Science','Other'];
    // colors to use for the categories
    const colors = ['#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462','#b3de69','#fccde5','#d9d9d9','#bc80bd','#ccebc5','#ffed6f'];

    function fillLegend(listOfValues,className){
        for (i = 0; i < listOfValues.length; i++) {
            var layer = listOfValues[i];
            var color = colors[i];
            var item = document.createElement('div');
            item.className = className;
            var key = document.createElement('span');
            key.className = 'legend-key';
            key.style.backgroundColor = color;

            var value = document.createElement('span');
            value.innerHTML = layer;
            item.appendChild(key);
            item.appendChild(value);
            legend.appendChild(item);
        }
        $("." + className).hide();
    }
    function hideLegendByLayer(layerId){
        $("." + layerId).hide();
    }
    function showLegendByLayer(layerId){
        $("." + layerId).show();
    }

    fillLegend(occupations,'ema_genie_circle');
    fillLegend(fieldOfStudies,'ema_genie_fieldOfStudy_circle');


    var occupation1 = ['==', ['get', 'Main occupation'], occupations[0]];
    var occupation2 = ['==', ['get', 'Main occupation'], occupations[1]];
    var occupation3 = ['==', ['get', 'Main occupation'], occupations[2]];
    var occupation4 = ['==', ['get', 'Main occupation'], occupations[3]];
    var occupation5 = ['==', ['get', 'Main occupation'], occupations[4]];
    var occupation6 = ['==', ['get', 'Main occupation'], occupations[5]];
    var occupation7 = ['all', ['!=', ['get', 'Main occupation'], occupations[0]], 
                              ['!=', ['get', 'Main occupation'], occupations[1]],
                              ['!=', ['get', 'Main occupation'], occupations[2]],
                              ['!=', ['get', 'Main occupation'], occupations[3]],
                              ['!=', ['get', 'Main occupation'], occupations[4]],
                              ['!=', ['get', 'Main occupation'], occupations[5]]];

    var fieldOfStudy1 = ['==', ['get', 'Field of study'], fieldOfStudies[0]];
    var fieldOfStudy2 = ['==', ['get', 'Field of study'], fieldOfStudies[1]];
    var fieldOfStudy3 = ['==', ['get', 'Field of study'], fieldOfStudies[2]];
    var fieldOfStudy4 = ['==', ['get', 'Field of study'], fieldOfStudies[3]];
    var fieldOfStudy5 = ['==', ['get', 'Field of study'], fieldOfStudies[4]];
    var fieldOfStudy6 = ['==', ['get', 'Field of study'], fieldOfStudies[5]];
    var fieldOfStudy7 = ['all', ['!=', ['get', 'Field of study'], occupations[0]], 
                              ['!=', ['get', 'Field of study'], occupations[1]],
                              ['!=', ['get', 'Field of study'], occupations[2]],
                              ['!=', ['get', 'Field of study'], occupations[3]],
                              ['!=', ['get', 'Field of study'], occupations[4]],
                              ['!=', ['get', 'Field of study'], occupations[5]]];

    $(document).ready(function () {
      $.ajax({
        type: "GET",
        //YOUR TURN: Replace with csv export link
        url: 'https://docs.google.com/spreadsheets/d/1-QOlufagyT4kxVafcp1kQYRYRLpNy0SC67z2xVfuuvI/gviz/tq?tqx=out:csv&sheet=mapbox',
        dataType: "text",
        success: function (csvData) { makeGeoJSON(csvData); }
      });

      function makeGeoJSON(csvData) {

        csv2geojson.csv2geojson(csvData, {
          latfield: 'Latitude',
          lonfield: 'Longitude',
          delimiter: ','
        }, function (err, data) {

            map.on('load', function () {
                // add a clustered GeoJSON source for a sample set of ema_genie
                map.addSource('ema_genie_fieldOfStudy', {
                    'type': 'geojson',
                    'data': data,
                    'cluster': true,
                    'clusterRadius': 80,
                    'clusterProperties': {
                        // keep separate counts for each magnitude category in a cluster
                        'fieldOfStudy1': ['+', ['case', fieldOfStudy1, 1, 0]],
                        'fieldOfStudy2': ['+', ['case', fieldOfStudy2, 1, 0]],
                        'fieldOfStudy3': ['+', ['case', fieldOfStudy3, 1, 0]],
                        'fieldOfStudy4': ['+', ['case', fieldOfStudy4, 1, 0]],
                        'fieldOfStudy5': ['+', ['case', fieldOfStudy5, 1, 0]],
                        'fieldOfStudy6': ['+', ['case', fieldOfStudy6, 1, 0]],
                        'fieldOfStudy7': ['+', ['case', fieldOfStudy7, 1, 0]]
                    }
                });

                map.addSource('ema_genie', {
                    'type': 'geojson',
                    'data': data,
                    'cluster': true,
                    'clusterRadius': 80,
                    'clusterProperties': {
                        // keep separate counts for each magnitude category in a cluster
                        'occupation1': ['+', ['case', occupation1, 1, 0]],
                        'occupation2': ['+', ['case', occupation2, 1, 0]],
                        'occupation3': ['+', ['case', occupation3, 1, 0]],
                        'occupation4': ['+', ['case', occupation4, 1, 0]],
                        'occupation5': ['+', ['case', occupation5, 1, 0]],
                        'occupation6': ['+', ['case', occupation6, 1, 0]],
                        'occupation7': ['+', ['case', occupation7, 1, 0]]
                    }
                });

                // circle and symbol layers for rendering individual ema_genie (unclustered points)
                map.addLayer({
                    'id': 'ema_genie_circle',
                    'type': 'circle',
                    'source': 'ema_genie',
                    'filter': ['!=', 'cluster', true],
                    'paint': {
                        'circle-color': [
                            'case',
                            occupation1,
                            colors[0],
                            occupation2,
                            colors[1],
                            occupation3,
                            colors[2],
                            occupation4,
                            colors[3],
                            occupation5,
                            colors[4],
                            occupation6,
                            colors[5],
                            occupation7,
                            colors[6],
                            colors[7]
                        ],
                        'circle-opacity': 0.8,
                        'circle-radius': 12
                    }
                });
                showLegendByLayer('ema_genie_circle');

                map.addLayer({
                    'id': 'ema_genie_fieldOfStudy_circle',
                    'type': 'circle',
                    'source': 'ema_genie_fieldOfStudy',
                    'filter': ['!=', 'cluster', true],
                    'layout': {'visibility':'none'},
                    'paint': {
                        'circle-color': [
                            'case',
                            fieldOfStudy1,
                            colors[0],
                            fieldOfStudy2,
                            colors[1],
                            fieldOfStudy3,
                            colors[2],
                            fieldOfStudy4,
                            colors[3],
                            fieldOfStudy5,
                            colors[4],
                            fieldOfStudy6,
                            colors[5],
                            fieldOfStudy7,
                            colors[6],
                            colors[7]
                        ],
                        'circle-opacity': 0.8,
                        'circle-radius': 12
                    }
                });

                // Create a popup, but don't add it to the map yet.
                var popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });
                function updatePopup(e){
                    var coordinates = e.features[0].geometry.coordinates.slice();

                    //set popup text 
                    //You can adjust the values of the popup to match the headers of your CSV. 
                    // For example: e.features[0].properties.Name is retrieving information from the field Name in the original CSV. 
                    var description = `<h3>` + e.features[0].properties["Main occupation"] + `</h3>` + 
                    `<h4>` + `<b>` + `Address: ` + `</b>` + e.features[0].properties.Addresse + 
                    `<br><b>` + `Field of study: ` + `</b>` + e.features[0].properties["Field of study"] +
                    `<br><b>` + `EMJMD: ` + `</b>` + e.features[0].properties.EMJMD + 
                    `<br><b>Start year:</b> ` + e.features[0].properties["Start year"] + `</h4>`;

                    // Ensure that if the map is zoomed out such that multiples
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    //add Popup to map
                    popup = new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);
                }

                map.on('click', 'ema_genie_circle', function (e) {
                    map.flyTo({
                        center:[e.lngLat.lng, e.lngLat.lat],
                    });

                    updatePopup(e);

                });


                map.on('mouseenter', 'ema_genie_circle', function (e) {
                    map.getCanvas().style.cursor = 'pointer';      
                    updatePopup(e);
                });

                map.on('mouseleave', 'ema_genie_circle', function () {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                });

                map.on('mouseenter', 'ema_genie_fieldOfStudy_circle', function (e) {
                    map.getCanvas().style.cursor = 'pointer';      
                    updatePopup(e);
                });

                map.on('mouseleave', 'ema_genie_fieldOfStudy_circle', function () {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                });

                map.addLayer({
                    'id': 'ema_genie_label',
                    'type': 'symbol',
                    'source': 'ema_genie',
                    'filter': ['!=', 'cluster', true],
                    'layout': {
                        'text-field': [
                            'number-format',
                            ['get', 'mag'],
                            { 'min-fraction-digits': 1, 'max-fraction-digits': 1 }
                        ],
                        'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                        'text-size': 10
                    },
                    'paint': {
                        'text-color': ['case',['<', ['get', 'Main occupation'], 3],'black','white']
                    }
                });
                
                map.addLayer({
                    'id': 'ema_genie_fieldOfStudy_label',
                    'type': 'symbol',
                    'source': 'ema_genie_fieldOfStudy',
                    'filter': ['!=', 'cluster', true],
                    'layout': {
                        'visibility': 'none',
                        'text-field': [
                            'number-format',
                            ['get', 'mag'],
                            { 'min-fraction-digits': 1, 'max-fraction-digits': 1 }
                        ],
                        'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                        'text-size': 10
                    },
                    'paint': {
                        'text-color': ['case',['<', ['get', 'Field of study'], 3],'black','white']
                    }
                });

                // after the GeoJSON data is loaded, update markers on the screen and do so on every map move/moveend
                map.on('data', function (e) {
                    if (e.sourceId !== 'ema_genie' || e.sourceId !== 'ema_genie_fieldOfStudy' || !e.isSourceLoaded) return;

                    map.on('move', function(){
                        updateMarkers('ema_genie');
                        updateMarkers('ema_genie_fieldOfStudy');
                    });

                    map.on('moveend', function(){
                        updateMarkers('ema_genie');
                        updateMarkers('ema_genie_fieldOfStudy');
                    });

                    updateMarkers('ema_genie');
                    updateMarkers('ema_genie_fieldOfStudy');
                });

                // enumerate ids of the layers
                var toggleableLayers = [{id:'ema_genie_circle',name:'Occupation',className:'active'}, {id:'ema_genie_fieldOfStudy_circle',name:'Field of study',className:''}];
                
                // set up the corresponding toggle button for each layer
                for (var i = 0; i < toggleableLayers.length; i++) {
                    var id = toggleableLayers[i].id;
                    var name = toggleableLayers[i].name;
                    var className = toggleableLayers[i].className;
                    var link = document.createElement('a');
                    link.href = '#';
                    link.className = className;
                    link.textContent = name;
                    link.layerId = id;
    
                    
                    link.onclick = function (e) {
                        var clickedLayer = this.layerId;
                        var notclickedLayers =  map.getStyle().layers.filter(layer => layer.id.indexOf("ema_genie")!==-1 && layer.id!==id); 
                        e.preventDefault();
                        e.stopPropagation();
                        
                        var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
                        
                        // toggle layer visibility by changing the layout object's visibility property
                        map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
                        showLegendByLayer(clickedLayer)
                        this.className = 'active';
                        for(var i; i < notclickedLayers.length; i++){
                            map.setLayoutProperty(i.id, 'visibility', 'none');
                            hideLegendByLayer(id.id)
                            this.className = '';
                        }
                    };
                    
                    var layers = document.getElementById('menu');
                    layers.appendChild(link);
                }
            });
        });
    };
});
 

// objects for caching and keeping track of HTML marker objects (for performance)
var markers = {};
var markersOnScreen = {};

function updateMarkers(source) {
    var newMarkers = {};
    var features = map.querySourceFeatures(source);

    // for every cluster on the screen, create an HTML marker for it (if we didn't yet),
    // and add it to the map if it's not there already
    for (var i = 0; i < features.length; i++) {
        var coords = features[i].geometry.coordinates;
        var props = features[i].properties;
        if (!props.cluster) continue;
        var id = props.cluster_id;

        var marker = markers[id];
        if (!marker) {
            console.log(props);
            var el = createDonutChart(props);
            marker = markers[id] = new mapboxgl.Marker({
                element: el
            }).setLngLat(coords);
        }
        newMarkers[id] = marker;

        if (!markersOnScreen[id]) marker.addTo(map);
    }
    // for every marker we've added previously, remove those that are no longer visible
    for (id in markersOnScreen) {
        if (!newMarkers[id]) markersOnScreen[id].remove();
    }
    markersOnScreen = newMarkers;
}   
// code for creating an SVG donut chart from feature properties
function createDonutChart(props) {
    var offsets = [];
    var counts = [];
    for (var key in props){
        if(props.hasOwnProperty(key)){
            counts.push(key);
        }
    }
    var total = 0;
    for (var i = 0; i < counts.length; i++) {
        offsets.push(total);
        total += counts[i];
    }
    var fontSize =
        total >= 1000 ? 22 : total >= 100 ? 20 : total >= 10 ? 18 : 16;
    var r = total >= 1000 ? 50 : total >= 100 ? 32 : total >= 10 ? 24 : 18;
    var r0 = Math.round(r * 0.6);
    var w = r * 2;

    var html =
        '<div><svg width="' +
        w +
        '" height="' +
        w +
        '" viewbox="0 0 ' +
        w +
        ' ' +
        w +
        '" text-anchor="middle" style="font: ' +
        fontSize +
        'px sans-serif; display: block">';

    for (i = 0; i < counts.length; i++) {
        html += donutSegment(
            offsets[i] / total,
            (offsets[i] + counts[i]) / total,
            r,
            r0,
            colors[i]
        );
    }
    html +=
        '<circle cx="' +
        r +
        '" cy="' +
        r +
        '" r="' +
        r0 +
        '" fill="white" /><text dominant-baseline="central" transform="translate(' +
        r +
        ', ' +
        r +
        ')">' +
        total.toLocaleString() +
        '</text></svg></div>';

    var el = document.createElement('div');
    el.innerHTML = html;
    return el.firstChild;
}

function donutSegment(start, end, r, r0, color) {
    if (end - start === 1) end -= 0.00001;
    var a0 = 2 * Math.PI * (start - 0.25);
    var a1 = 2 * Math.PI * (end - 0.25);
    var x0 = Math.cos(a0),
        y0 = Math.sin(a0);
    var x1 = Math.cos(a1),
        y1 = Math.sin(a1);
    var largeArc = end - start > 0.5 ? 1 : 0;

    return [
        '<path d="M',
        r + r0 * x0,
        r + r0 * y0,
        'L',
        r + r * x0,
        r + r * y0,
        'A',
        r,
        r,
        0,
        largeArc,
        1,
        r + r * x1,
        r + r * y1,
        'L',
        r + r0 * x1,
        r + r0 * y1,
        'A',
        r0,
        r0,
        0,
        largeArc,
        0,
        r + r0 * x0,
        r + r0 * y0,
        '" fill="' + color + '" />'
    ].join(' ');
    
}
</script>

</body>
</html>