<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Display HTML clusters with custom properties</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src='https://npmcdn.com/csv2geojson@latest/csv2geojson.js'></script>
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>

<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoiZ2VvbXVuZHVzIiwiYSI6ImNqM3BoMDVlYjAwam8zMnBmNm1ndWs3bnYifQ.McVUJig2reapiExh7EPOpw';
    var map = new mapboxgl.Map({
        container: 'map',
        zoom: 0.3,
        center: [0, 20],
        style: 'mapbox://styles/geomundus/ckibtpc8y12i71amxds9gn4l0'
    });

    map.addControl(new mapboxgl.NavigationControl());

    // filters for classifying earthquakes into five categories based on magnitude
    var occupation1 = ['==', ['get', 'Main occupation'], 'I recently graduated and I am looking for a job'];
    var occupation2 = ['==', ['get', 'Main occupation'], 'I work in a private company'];
    var occupation3 = ['==', ['get', 'Main occupation'], 'I am a 1st year Master student'];
    var occupation4 = ['==', ['get', 'Main occupation'], 'I work for the government'];
    var occupation5 = ['==', ['get', 'Main occupation'], 'I am a researcher/doing my PhD'];
    var occupation6 = ['==', ['get', 'Main occupation'], 'I work at a university or public institute'];
    var occupation7 = ['all', ['<>', ['get', 'Main occupation'], 'I recently graduated and I am looking for a job'], 
                              ['<>', ['get', 'Main occupation'], 'I work in a private company'],
                              ['<>', ['get', 'Main occupation'], 'I am a 1st year Master student'],
                              ['<>', ['get', 'Main occupation'], 'I work for the government'],
                              ['<>', ['get', 'Main occupation'], 'I am a researcher/doing my PhD'],
                              ['<>', ['get', 'Main occupation'], 'I work at a university or public institute']];

    // colors to use for the categories
    //var colors = ['#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c'];
    const colors = ['#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462','#b3de69','#fccde5','#d9d9d9','#bc80bd','#ccebc5','#ffed6f'];
    
    $(document).ready(function () {
      $.ajax({
        type: "GET",
        //YOUR TURN: Replace with csv export link
        url: 'https://docs.google.com/spreadsheets/d/1-QOlufagyT4kxVafcp1kQYRYRLpNy0SC67z2xVfuuvI/gviz/tq?tqx=out:csv&sheet=mapbox',
        dataType: "text",
        success: function (csvData) { makeGeoJSON(csvData); }
      });



      function makeGeoJSON(csvData) {

        csv2geojson.csv2geojson(csvData, {
          latfield: 'Latitude',
          lonfield: 'Longitude',
          delimiter: ','
        }, function (err, data) {

        map.on('load', function () {
            // add a clustered GeoJSON source for a sample set of earthquakes
            map.addSource('ema_genie', {
                'type': 'geojson',
                'data': data,
                'cluster': true,
                'clusterRadius': 80,
                'clusterProperties': {
                    // keep separate counts for each magnitude category in a cluster
                    'occupation1': ['+', ['case', occupation1, 1, 0]],
                    'occupation2': ['+', ['case', occupation2, 1, 0]],
                    'occupation3': ['+', ['case', occupation3, 1, 0]],
                    'occupation4': ['+', ['case', occupation4, 1, 0]],
                    'occupation5': ['+', ['case', occupation5, 1, 0]],
                    'occupation6': ['+', ['case', occupation6, 1, 0]],
                    'occupation7': ['+', ['case', occupation7, 1, 0]]
                }
            });


            // circle and symbol layers for rendering individual ema_genie (unclustered points)
            map.addLayer({
                'id': 'ema_genie_circle',
                'type': 'circle',
                'source': 'ema_genie',
                'filter': ['!=', 'cluster', true],
                'paint': {
                    'circle-color': [
                        'case',
                        occupation1,
                        colors[0],
                        occupation2,
                        colors[1],
                        occupation3,
                        colors[2],
                        occupation4,
                        colors[3],
                        occupation5,
                        colors[4],
                        occupation6,
                        colors[5],
                        occupation7,
                        colors[6],
                        colors[7]
                    ],
                    'circle-opacity': 0.6,
                    'circle-radius': 12
                }
            });
            map.addLayer({
                'id': 'ema_genie_label',
                'type': 'symbol',
                'source': 'ema_genie',
                'filter': ['!=', 'cluster', true],
                'layout': {
                    'text-field': [
                        'number-format',
                        ['get', 'mag'],
                        { 'min-fraction-digits': 1, 'max-fraction-digits': 1 }
                    ],
                    'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                    'text-size': 10
                },
                'paint': {
                    'text-color': [
                        'case',
                        ['<', ['get', 'Main occupation'], 3],
                        'black',
                        'white'
                    ]
                }
            });

            // objects for caching and keeping track of HTML marker objects (for performance)
            var markers = {};
            var markersOnScreen = {};

            function updateMarkers() {
                var newMarkers = {};
                var features = map.querySourceFeatures('earthquakes');

                // for every cluster on the screen, create an HTML marker for it (if we didn't yet),
                // and add it to the map if it's not there already
                for (var i = 0; i < features.length; i++) {
                    var coords = features[i].geometry.coordinates;
                    var props = features[i].properties;
                    if (!props.cluster) continue;
                    var id = props.cluster_id;

                    var marker = markers[id];
                    if (!marker) {
                        var el = createDonutChart(props);
                        marker = markers[id] = new mapboxgl.Marker({
                            element: el
                        }).setLngLat(coords);
                    }
                    newMarkers[id] = marker;

                    if (!markersOnScreen[id]) marker.addTo(map);
                }
                // for every marker we've added previously, remove those that are no longer visible
                for (id in markersOnScreen) {
                    if (!newMarkers[id]) markersOnScreen[id].remove();
                }
                markersOnScreen = newMarkers;
            }

            // after the GeoJSON data is loaded, update markers on the screen and do so on every map move/moveend
            map.on('data', function (e) {
                if (e.sourceId !== 'ema_genie' || !e.isSourceLoaded) return;

                map.on('move', updateMarkers);
                map.on('moveend', updateMarkers);
                updateMarkers();
            });

        });
    });
};
});
    
    // code for creating an SVG donut chart from feature properties
    function createDonutChart(props) {
        var offsets = [];
        var counts = [
            props.occupation1,
            props.occupation2,
            props.occupation3,
            props.occupation4,
            props.occupation5,
            props.occupation6,
            props.occupation7
        ];
        var total = 0;
        for (var i = 0; i < counts.length; i++) {
            offsets.push(total);
            total += counts[i];
        }
        var fontSize =
            total >= 1000 ? 22 : total >= 100 ? 20 : total >= 10 ? 18 : 16;
        var r = total >= 1000 ? 50 : total >= 100 ? 32 : total >= 10 ? 24 : 18;
        var r0 = Math.round(r * 0.6);
        var w = r * 2;

        var html =
            '<div><svg width="' +
            w +
            '" height="' +
            w +
            '" viewbox="0 0 ' +
            w +
            ' ' +
            w +
            '" text-anchor="middle" style="font: ' +
            fontSize +
            'px sans-serif; display: block">';

        for (i = 0; i < counts.length; i++) {
            html += donutSegment(
                offsets[i] / total,
                (offsets[i] + counts[i]) / total,
                r,
                r0,
                colors[i]
            );
        }
        html +=
            '<circle cx="' +
            r +
            '" cy="' +
            r +
            '" r="' +
            r0 +
            '" fill="white" /><text dominant-baseline="central" transform="translate(' +
            r +
            ', ' +
            r +
            ')">' +
            total.toLocaleString() +
            '</text></svg></div>';

        var el = document.createElement('div');
        el.innerHTML = html;
        return el.firstChild;
    }

    function donutSegment(start, end, r, r0, color) {
        if (end - start === 1) end -= 0.00001;
        var a0 = 2 * Math.PI * (start - 0.25);
        var a1 = 2 * Math.PI * (end - 0.25);
        var x0 = Math.cos(a0),
            y0 = Math.sin(a0);
        var x1 = Math.cos(a1),
            y1 = Math.sin(a1);
        var largeArc = end - start > 0.5 ? 1 : 0;

        return [
            '<path d="M',
            r + r0 * x0,
            r + r0 * y0,
            'L',
            r + r * x0,
            r + r * y0,
            'A',
            r,
            r,
            0,
            largeArc,
            1,
            r + r * x1,
            r + r * y1,
            'L',
            r + r0 * x1,
            r + r0 * y1,
            'A',
            r0,
            r0,
            0,
            largeArc,
            0,
            r + r0 * x0,
            r + r0 * y0,
            '" fill="' + color + '" />'
        ].join(' ');
        
    }
</script>

</body>
</html>